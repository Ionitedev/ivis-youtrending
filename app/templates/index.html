<!DOCTYPE html>
<html>
    <head>
        <title>Youtube Trending</title>
        <script src="https://d3js.org/d3.v4.js"></script>
        <link rel="shortcut icon" href="static/images/icons/favicon.ico" type="image/x-icon">
    </head>
    <body style="height: 95vh;">
        <div id='sidebar' style="float: left; width: 15%; height: 100%; font-size: large; background-color: #991b1b;">
            <img src='static/images/YouTrendingLOGO.png' width="80%" style="margin-left: 10%; margin-top: 10%; margin-bottom: 10%;">   

            <form action='/' method='POST' style="margin-left: 15%;">
                <p style="color: mintcream;">Trending Time:</p>
                <select name='time' id='select_time' style="font-size: large; width: 80%;">
                    <option value='1w' selected>Last week</option>
                    <option value='1m' {% if selected[0] == '1m' %} selected {% endif %}>Last month</option>
                    <option value='3m' {% if selected[0] == '3m' %} selected {% endif %}>Last 3 months</option>
                    <option value='all' {% if selected[0] == 'all' %} selected {% endif %}>All</option>
                </select>
                <br>
                <p style="color: mintcream;">Country:</p>
                <select name='country' id='select_country' style="font-size: large; width: 80%;">
                    <option value='all' {% if selected[1] == 'all' %} selected {% endif %}>All</option>
                    <option value='br' {% if selected[1] == 'br' %} selected {% endif %}>Brazil</option>
                    <option value='ca' {% if selected[1] == 'ca' %} selected {% endif %}>Canada</option>
                    <option value='de' {% if selected[1] == 'de' %} selected {% endif %}>Germany</option>
                    <option value='fr' {% if selected[1] == 'fr' %} selected {% endif %}>France</option>
                    <option value='gb' {% if selected[1] == 'gb' %} selected {% endif %}>Great Britain</option>
                    <option value='in' {% if selected[1] == 'in' %} selected {% endif %}>India</option>
                    <option value='jp' {% if selected[1] == 'jp' %} selected {% endif %}>Japan</option>
                    <option value='kr' {% if selected[1] == 'kr' %} selected {% endif %}>South Korea</option>
                    <option value='mx' {% if selected[1] == 'mx' %} selected {% endif %}>Mexico</option>
                    <option value='ru' {% if selected[1] == 'ru' %} selected {% endif %}>Russia</option>
                    <option value='us' {% if selected[1] == 'us' %} selected {% endif %}>United States</option>
                </select>
                <br>
                <p style="color: mintcream;">Language:</p>
                <select name='lang' id='select_lang' style="font-size: large; width: 80%;">
                    <option value='all' {% if selected[2] == 'all' %} selected {% endif %}>All</option>
                    <option value='en' {% if selected[2] == 'en' %} selected {% endif %}>English</option>
                </select>
                <br><br><br>
                <center style="margin-left: -18%;"><input type='submit' value='Filter' style="font-size: large;"></center>                
            </form>

        </div>

        <div id='treemap'></div>

        <script>            
            // set the dimensions and margins of the graph
            var margin = {top: 0, right: 10, bottom: 0, left: 10},
                width = window.innerWidth * 0.83 - margin.left - margin.right,
                height = window.innerHeight * 0.95 + 20 - margin.top - margin.bottom;
        
            // append the svg object to the body of the page
            var svg = d3.select("#treemap")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
            // color_value: video_count / sum(video_count) in category top
            // size_value: color_value * category_count
            // count: real view count

            var data = {
                "children":[
                    {
                        "name":"food",
                        "children":[
                            {
                                'title':'title1',
                                "channel":"mister_a",
                                "count":28,
                                'color_value':0.6,
                                'size_value':1.2,
                                'pubdate':'1999-08-31',
                                "trenddate1":"1999-09-01",
                                "trenddate2":"1999-09-05",
                                'cover_url':'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Image_created_with_a_mobile_phone.png/1280px-Image_created_with_a_mobile_phone.png'
                            }, {
                                'title':'title2',
                                "channel":"mister_ab",
                                "count":18,
                                'color_value':0.4,
                                'size_value':0.8,
                                'pubdate':'1999-08-31',
                                "trenddate1":"1999-09-01",
                                "trenddate2":"1999-09-05",
                                'cover_url':'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Image_created_with_a_mobile_phone.png/1280px-Image_created_with_a_mobile_phone.png'
                            }
                        ],
                    }, {
                        "name":"love",
                        "children":[
                            {
                                'title':'title3',
                                "channel":"mister_e",
                                "count":19,
                                'color_value':0.7,
                                'size_value':2.1,
                                'pubdate':'1999-08-31',
                                "trenddate1":"1999-09-01",
                                "trenddate2":"1999-09-05",
                                'cover_url':'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Image_created_with_a_mobile_phone.png/1280px-Image_created_with_a_mobile_phone.png'
                            }, {
                                'title':'title4',
                                "channel":"mister_acb",
                                "count":8,
                                'color_value':0.3,
                                'size_value':0.9,
                                'pubdate':'1999-08-31',
                                "trenddate1":"1999-09-01",
                                "trenddate2":"1999-09-05",
                                'cover_url':'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Image_created_with_a_mobile_phone.png/1280px-Image_created_with_a_mobile_phone.png'
                            }
                        ],
                    }, {
                        "name":"fight",
                        "children":[
                            {
                                'title':'title5',
                                "channel":"mister_j",
                                "count":9,
                                'color_value':0.33,
                                'size_value':1.32,
                                'pubdate':'1999-08-31',
                                "trenddate1":"1999-09-01",
                                "trenddate2":"1999-09-05",
                                'cover_url':'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Image_created_with_a_mobile_phone.png/1280px-Image_created_with_a_mobile_phone.png'
                            }, {
                                'title':'title6',
                                "channel":"mister_ab",
                                "count":18,
                                'color_value':0.67,
                                'size_value':2.68,
                                'pubdate':'1999-08-31',
                                "trenddate1":"1999-09-01",
                                "trenddate2":"1999-09-05",
                                'cover_url':'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Image_created_with_a_mobile_phone.png/1280px-Image_created_with_a_mobile_phone.png'
                            }
                        ],
                    }
                ]
            };
            
            var root = d3.hierarchy(data).sum(function(d){ return d.size_value}) // Here the size of each leave is given in the 'value' field in input data
        
            // Give the data to this cluster layout:
            d3.treemap()
                .size([width, height])
                .paddingTop(28)
                .paddingRight(8)
                .paddingInner(1)      // Padding between each rectangle
                //.paddingOuter(6)
                //.padding(20)
                (root)
        
            // prepare a color scale
            var color = d3.scaleOrdinal()
                .range([ "#DC143C", "#FF0000", "#FF4500"])
        
            // And a opacity scale
            var opacity = d3.scaleLinear()
                .domain([0.2, 0.5])
                .range([0.6, 0.9])
        
            var Tooltip = d3.select("#treemap")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style('position', 'absolute')
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px")
                .style('visibility', 'hidden')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .style('width', '180px')
                .text('')
            // Three function that change the tooltip when user hover / move / leave a cell
            var mouseover = function(d) {
                Tooltip
                    .style("opacity", 1)
                    .style('visibility', 'visible')
                // d3.select(this)
                //     .style("stroke", "black")
                //     .style("opacity", 1);
                    .html(
                        '<img src=' + d.data.cover_url + ' width=\'100%\' >' + '<br>' +
                        'Title: ' + d.data.title + '<br>' +
                        'Channel: ' + d.data.channel + '<br>' +
                        'Publish date: ' + d.data.pubdate + '<br>' +
                        'First trending date: ' + d.data.trenddate1 + '<br>' +
                        'Last trending date: ' + d.data.trenddate2 + '<br>' +
                        'View: ' + d.data.count
                    )
                    .style("left", (parseInt(d3.select(this).attr("x")) + window.innerWidth * 0.15 + 15) + "px")
                    .style("top", d3.select(this).attr("y")  + "px")        
            }
            
            var mouseleave = function(d) {
                Tooltip
                    .style("opacity", 0)
                    .style("left", "-100%")
                    .style("top", "-100%")
                // d3.select(this)
                //     .style("stroke", "none")
                //     .style("opacity", 0.8)
            }
        
            // use this information to add rectangles:
            //d 是node
            svg
                .selectAll("rect")
                .data(root.leaves())
                .enter()
                .append("rect")
                .attr('x', function (d) { return d.x0; })
                .attr('y', function (d) { return d.y0-20; })
                .attr('width', function (d) { return (d.x1 - d.x0); })
                .attr('height', function (d) { return (d.y1 - d.y0); })
                .on("mouseover", mouseover)
                .on("mouseleave", mouseleave)
                .style("stroke", "black")
                .style("fill", function(d){ return color(d.parent.data.name)} )
                .style("opacity", function(d){ return opacity(d.data.color_value)})
        
            // video title
            svg
                .selectAll("id")
                .data(root.leaves())
                .enter()
                .append("text")
                .attr("x", function(d){ return d.x0+5})    // +10 to adjust position (more right)
                .attr("y", function(d){ return d.y0+5})    // +20 to adjust position (lower)
                //.text(function(d){ return d.parent.data["name"];})
                .text(function(d){ return d.data.title })
                .attr("font-size", "15px")
                .attr("fill", "white")
        
            // category name
            svg
                .selectAll("titles")
                .data(root.descendants().filter(function(d){return d.depth==1}))
                .enter()
                .append("text")
                .attr("x", function(d){ return d.x0})
                .attr("y", function(d){ return d.y0})
                .text(function(d){ return d.data.name; })
                .attr("font-size", "20px")
                .attr('font-weight', 'bold')
                .attr("fill",  function(d){ return color(d.data.name)} )
                .on("click", function(d) {
                    var f = document.createElement('form');
                    f.setAttribute('style', 'visibility: hidden;');
                    f.setAttribute('method', 'post');
                    f.setAttribute('action', '/category');

                    var filter = ['time', 'country', 'lang'];
                    for (var i = 0; i < 3; i++) {
                        var s = document.createElement("input");
                        s.setAttribute('style', 'visibility: hidden');
                        s.setAttribute('type', "text");
                        s.setAttribute('name', filter[i]);
                        s.setAttribute('value', document.getElementById('select_' + filter[i]).value);
                        f.appendChild(s);
                    }

                    var s = document.createElement("input");
                    s.setAttribute('style', 'visibility: hidden');
                    s.setAttribute('type', "text");
                    s.setAttribute('name', 'category');
                    s.setAttribute('value', d.data.name);
                    f.appendChild(s);

                    document.body.appendChild(f);
                    f.submit();
                })
        </script>
    </body>

</html>